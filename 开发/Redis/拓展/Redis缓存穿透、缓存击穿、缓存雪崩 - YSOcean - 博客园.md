# Redis缓存穿透、缓存击穿、缓存雪崩 - YSOcean - 博客园
* * *

　　本篇博客我们来介绍 Redis 使用过程中需要注意的三种问题：**缓存穿透、缓存击穿、缓存雪崩。** 

### 1、缓存穿透

#### 一、概念

　　缓存穿透：缓存和数据库中都没有的数据，可用户还是源源不断的发起请求，导致每次请求都会到数据库，从而压垮数据库。

　　如下图红色的流程：

　　![](https://img2020.cnblogs.com/blog/1120165/202008/1120165-20200808214325134-1676845673.png)

 　　比如客户查询一个根本不存在的东西，首先从 Redis 中查不到，然后会去数据库中查询，数据库中也查询不到，那么就不会将数据放入到缓存中，后面如果还有类似源源不断的请求，最后都会压到数据库来处理，从而给数据库造成巨大的压力。

#### 二、解决办法

　　**①、业务层校验**

　　用户发过来的请求，根据请求参数进行校验，对于明显错误的参数，直接拦截返回。

　　比如，请求参数为主键自增 id，那么对于请求小于 0 的 id 参数，明显不符合，可以直接返回错误请求。

　　**②、不存在数据设置短过期时间**

对于某个查询为空的数据，可以将这个空结果进行 Redis 缓存，但是设置很短的过期时间，比如 30s，可以根据实际业务设定。注意一定不要影响正常业务。

　　**③、布隆过滤器**

　　关于布隆过滤器，后面会详细介绍。布隆过滤器是一种数据结构，利用极小的内存，可以判断大量的数据 “一定不存在或者可能存在”。

　　对于缓存穿透，我们可以将查询的数据条件都哈希到一个足够大的布隆过滤器中，用户发送的请求会先被布隆过滤器拦截，一定不存在的数据就直接拦截返回了，从而避免下一步对数据库的压力。

### 2、缓存击穿

#### 一、概念

　　缓存击穿：Redis 中一个热点 key 在失效的同时，大量的请求过来，从而会全部到达数据库，压垮数据库。

　　![](https://img2020.cnblogs.com/blog/1120165/202008/1120165-20200808214359739-1247536410.png)

 　　这里要注意的是这是某一个热点 key 过期失效，和后面介绍缓存雪崩是有区别的。比如淘宝双十一，对于某个特价热门的商品信息，缓存在 Redis 中，刚好 0 点，这个商品信息在 Redis 中过期查不到了，这时候大量的用户又同时正好访问这个商品，就会造成大量的请求同时到达数据库。

#### 二、解决办法

　　**①、设置热点数据永不过期**

　　对于某个需要频繁获取的信息，缓存在 Redis 中，并设置其永不过期。当然这种方式比较粗暴，对于某些业务场景是不适合的。

　　**②、定时更新**

　　比如这个热点数据的过期时间是 1h，那么每到 59minutes 时，通过定时任务去更新这个热点 key，并重新设置其过期时间。

　　③**、互斥锁**

这是解决缓存击穿比较常用的方法。

　　互斥锁简单来说就是在 Redis 中根据 key 获得的 value 值为空时，先锁上，然后从数据库加载，加载完毕，释放锁。若其他线程也在请求该 key 时，发现获取锁失败，则睡眠一段时间（比如 100ms）后重试。

### **3、缓存雪崩**

#### 一、概念

　　缓存雪崩：Redis 中缓存的数据大面积同时失效，或者 Redis 宕机，从而会导致大量请求直接到数据库，压垮数据库。

　　![](https://img2020.cnblogs.com/blog/1120165/202003/1120165-20200329215008122-335003416.png)

 　　对于一个业务系统，如果 Redis 宕机或大面积的 key 同时过期，会导致大量请求同时打到数据库，这是灾难性的问题。

#### 二、解决办法

　　**①、设置有效期均匀分布**

　　避免缓存设置相近的有效期，我们可以在设置有效期时增加随机值；

　　或者统一规划有效期，使得过期时间均匀分布。

　　**②、数据预热**

　　对于即将来临的大量请求，我们可以提前走一遍系统，将数据提前缓存在 Redis 中，并设置不同的过期时间。

　　**③、保证 Redis 服务高可用**

　　前面我们介绍过 Redis 的哨兵模式和集群模式，为防止 Redis 集群单节点故障，可以通过这两种模式实现高可用。 
 [https://www.cnblogs.com/ysocean/p/12452023.html](https://www.cnblogs.com/ysocean/p/12452023.html)
